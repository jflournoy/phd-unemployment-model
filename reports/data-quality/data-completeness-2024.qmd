---
title: "Data Completeness Report: CPS 2024"
author: "PhD Unemployment Analysis Project"
date: today
format:
  html:
    toc: true
    toc-depth: 3
    code-fold: false
    embed-resources: true
    theme: cosmo
    fig-width: 10
    fig-height: 6
---

## Executive Summary

This report validates the completeness and quality of the downloaded CPS (Current Population Survey) data for 2024. The analysis ensures all expected months are present with sufficient sample sizes and complete variable coverage before proceeding with statistical modeling.

## Data Loading and Overview

```{r setup, message=FALSE}
library(here)
source(here("R", "data-completeness.R"))

# Load CPS data
cps_data <- readRDS(here("data-raw", "ipums_data.rds"))

cat("Dataset dimensions:", nrow(cps_data), "rows ×", ncol(cps_data), "columns\n")
cat("Year coverage:", paste(unique(cps_data$YEAR), collapse = ", "), "\n")
cat("Month coverage:", paste(sort(unique(cps_data$MONTH)), collapse = ", "), "\n")
```

## Variable Coverage

```{r variables}
# Display all variables in dataset
cat("Variables in dataset:\n")
cat(paste("-", names(cps_data), collapse = "\n"), "\n")
```

## Completeness Analysis

### Core Variables Check

```{r completeness_core}
# Generate completeness report for core variables
report <- generate_completeness_report(
  cps_data,
  expected_months = 1:12,
  min_obs = 100,
  required_vars = c("YEAR", "MONTH", "EMPSTAT", "EDUC")
)

# Print formatted report
print_completeness_report(report)
```

### Month-by-Month Sample Sizes

```{r sample_sizes, fig.height=5}
# Create bar plot of sample sizes by month
par(mar = c(5, 4, 4, 2) + 0.1)
barplot(
  report$n_obs,
  names.arg = month.abb,
  col = ifelse(report$issue == "OK", "steelblue", "coral"),
  border = NA,
  main = "CPS Sample Size by Month (2024)",
  xlab = "Month",
  ylab = "Number of Observations",
  ylim = c(0, max(report$n_obs) * 1.1)
)

# Add horizontal line for minimum threshold
abline(h = 100, col = "red", lty = 2, lwd = 2)
text(1, 110, "Minimum threshold", col = "red", pos = 4, cex = 0.8)

# Add value labels
text(1:12, report$n_obs + 5000,
     format(report$n_obs, big.mark = ","),
     cex = 0.7, srt = 90, adj = 0)
```

### Completeness Percentage by Month

```{r completeness_pct, fig.height=5}
# Create bar plot of completeness percentages
par(mar = c(5, 4, 4, 2) + 0.1)
barplot(
  report$pct_complete,
  names.arg = month.abb,
  col = ifelse(report$pct_complete == 100, "darkgreen", "orange"),
  border = NA,
  main = "Data Completeness by Month (2024)",
  xlab = "Month",
  ylab = "Completeness (%)",
  ylim = c(0, 110)
)

# Add 100% reference line
abline(h = 100, col = "red", lty = 2, lwd = 2)

# Add percentage labels
text(1:12, report$pct_complete + 3,
     sprintf("%.1f%%", report$pct_complete),
     cex = 0.8)
```

## Weight Variable Verification

```{r weights}
# Check weight variables
cat("=== Weight Variable Coverage ===\n\n")

# WTFINL (regular months)
wtfinl_summary <- data.frame(
  Month = month.abb,
  Has_WTFINL = sapply(1:12, function(m) {
    month_data <- cps_data[cps_data$MONTH == m, ]
    sum(!is.na(month_data$WTFINL))
  }),
  Has_ASECWT = sapply(1:12, function(m) {
    if (!"ASECWT" %in% names(cps_data)) return(0)
    month_data <- cps_data[cps_data$MONTH == m, ]
    sum(!is.na(month_data$ASECWT))
  })
)

print(wtfinl_summary)

cat("\nNote: ASECWT is only present in March ASEC supplement.\n")
cat("All other months use WTFINL for person weights.\n")
```

## Validation Results

```{r validation}
# Quick validation check
is_complete <- validate_data_completeness(
  cps_data,
  expected_months = 1:12,
  min_obs = 100,
  required_vars = c("YEAR", "MONTH", "EMPSTAT", "EDUC")
)

cat("\n=== Overall Validation ===\n\n")
if (is_complete) {
  cat("✓ PASS: All completeness checks passed!\n")
  cat("  - All 12 months present\n")
  cat("  - All months meet minimum sample size (100+ observations)\n")
  cat("  - All required variables have complete data\n")
} else {
  cat("✗ FAIL: Data has completeness issues\n")
  cat("  See detailed report above for specific issues\n")
}
```

## Detailed Statistics

### Sample Size Statistics

```{r stats}
cat("\n=== Sample Size Statistics ===\n\n")
cat("Total observations:", format(sum(report$n_obs), big.mark = ","), "\n")
cat("Mean per month:", format(round(mean(report$n_obs)), big.mark = ","), "\n")
cat("Median per month:", format(median(report$n_obs), big.mark = ","), "\n")
cat("Min per month:", format(min(report$n_obs), big.mark = ","),
    "(", month.abb[which.min(report$n_obs)], ")\n")
cat("Max per month:", format(max(report$n_obs), big.mark = ","),
    "(", month.abb[which.max(report$n_obs)], ")\n")

cat("\nNote: March has larger sample due to ASEC supplement\n")
```

### Missing Data Analysis

```{r missing}
# Check for any missing data in core variables
cat("\n=== Missing Data Analysis ===\n\n")

core_vars <- c("YEAR", "MONTH", "EMPSTAT", "EDUC", "WTFINL")
missing_counts <- sapply(core_vars, function(var) {
  if (var %in% names(cps_data)) {
    sum(is.na(cps_data[[var]]))
  } else {
    NA
  }
})

missing_pct <- (missing_counts / nrow(cps_data)) * 100

missing_summary <- data.frame(
  Variable = core_vars,
  Missing_Count = missing_counts,
  Missing_Pct = sprintf("%.2f%%", missing_pct)
)

print(missing_summary)

if (all(missing_counts[!is.na(missing_counts)] == 0)) {
  cat("\n✓ No missing data detected in core variables\n")
} else {
  cat("\n⚠ Some variables have missing data\n")
}
```

## PhD Sample Analysis

```{r phd_sample}
# Filter to PhD holders (EDUC >= 116 for doctorate)
phd_data <- cps_data[cps_data$EDUC >= 116, ]

cat("\n=== PhD Subsample Analysis ===\n\n")
cat("Total PhD observations:", nrow(phd_data), "\n")
cat("Percentage of total:", sprintf("%.2f%%", 100 * nrow(phd_data) / nrow(cps_data)), "\n")

# PhD sample by month
phd_by_month <- table(phd_data$MONTH)
cat("\nPhD observations by month:\n")
for (m in 1:12) {
  count <- phd_by_month[as.character(m)]
  cat(sprintf("  %3s: %4d\n", month.abb[m], count))
}

cat("\nMean PhD obs/month:", round(mean(phd_by_month)), "\n")
```

## Data Quality Certification

```{r certification}
cat("\n=== Data Quality Certification ===\n\n")
cat("Report generated:", format(Sys.time(), "%Y-%m-%d %H:%M:%S %Z"), "\n")
cat("Data file: data-raw/ipums_data.rds\n")
cat("Total records:", format(nrow(cps_data), big.mark = ","), "\n")
cat("Year:", unique(cps_data$YEAR), "\n")
cat("Months covered:", paste(range(cps_data$MONTH), collapse = "-"), "\n\n")

if (is_complete) {
  cat("✓ CERTIFIED: Data is complete and ready for analysis\n")
  cat("  - All expected months present (12/12)\n")
  cat("  - Sample sizes exceed minimum thresholds\n")
  cat("  - All required variables complete\n")
  cat("  - Weight variables properly distributed\n")
  cat("  - PhD subsample has sufficient observations\n\n")
  cat("This dataset is approved for:\n")
  cat("  - Unemployment rate calculations\n")
  cat("  - Seasonal adjustment modeling\n")
  cat("  - Time series analysis\n")
  cat("  - Demographic comparisons\n")
} else {
  cat("✗ ISSUES DETECTED: Review report for details\n")
}
```

## Export Results

```{r export}
# Save completeness report to CSV
output_file <- here("data", "completeness_report_2024.csv")
write.csv(report, output_file, row.names = FALSE)
cat("\nCompleteness report saved to:", output_file, "\n")
```

## Conclusion

This automated completeness check ensures the CPS data download was successful and the data meets quality standards for statistical analysis. All checks must pass before proceeding with unemployment rate calculations and modeling.

For questions about data completeness methodology, see:
- `R/data-completeness.R` - Completeness checking functions
- `tests/testthat/test-data-completeness-report.R` - Automated tests
- `data-raw/WEIGHTS-NOTES.md` - Survey weights documentation
