---
title: "PhD Unemployment in Context: A Quasi-Binomial Analysis Across Education Levels"
author: "PhD Unemployment Research"
date: today
format:
  html:
    toc: true
    toc-depth: 3
    code-fold: true
    code-summary: "Show code"
    theme: cosmo
    highlight-style: github
    embed-resources: true
    self-contained: true
execute:
  echo: true
  warning: false
  message: false
  cache: false
---

## Executive Summary

This analysis models unemployment rates across seven education levels using a quasi-binomial GAM with education-specific adaptive time trends and seasonal patterns.

---

## Data & Methods

```{r}
#| label: setup
library(mgcv)
library(data.table)
library(ggplot2)
library(here)

# Load count data
counts_data <- readRDS(here("data", "education-spectrum-counts.rds"))
data <- as.data.table(counts_data)

# Prepare data
data$education <- factor(data$education)
data$month <- as.integer(data$month)

# Add year variables
if (!"year" %in% names(data)) {
  data$year <- 2000 + floor((data$time_index - 1) / 12)
}
data$year_cont <- data$year + (data$month - 0.5) / 12

# Common plot settings
edu_labels <- c(
  "bachelors" = "Bachelor's Degree",
  "high_school" = "High School",
  "less_than_hs" = "Less than High School",
  "masters" = "Master's Degree",
  "phd" = "PhD",
  "professional" = "Professional Degree",
  "some_college" = "Some College"
)

edu_colors <- c(
  "phd" = "#1f77b4",
  "professional" = "#ff7f0e",
  "masters" = "#2ca02c",
  "bachelors" = "#d62728",
  "some_college" = "#9467bd",
  "high_school" = "#8c564b",
  "less_than_hs" = "#e377c2"
)

cat("Data Summary:\n")
cat("- Time period:", min(data$year), "to", max(data$year), "\n")
cat("- Total months:", nrow(data) / length(unique(data$education)), "\n")
cat("- Education levels:", length(unique(data$education)), "\n")
cat("- Total observations:", nrow(data), "\n")
```

### Model Specification

The model decomposes unemployment into global effects and education-specific deviations:

$$\text{cbind}(n_{unemployed}, n_{employed}) \sim \text{education} + s(\text{year\_cont}) + s(\text{year\_cont}, \text{by=education}) + s(\text{month}, \text{bs="cc"}) + s(\text{month}, \text{by=education}, \text{bs="cc"})$$

**Key design choices:**

- **Global time trend**: `s(year_cont, bs="ad")` captures the overall unemployment trajectory
- **Education time deviations**: `s(year_cont, by=education, bs="ad")` captures how each education level deviates from global
- **Global seasonality**: `s(month, bs="cc")` captures the common seasonal pattern
- **Education seasonal deviations**: `s(month, by=education, bs="cc")` captures education-specific seasonal differences
- **Shared smoothing**: `id=` constraints ensure consistent wiggliness within each effect type

```{r}
#| label: fit-model
#| code-fold: false
# Fit the quasi-binomial GAM with education-specific smooths
cat("\n=== Fitting Model ===\n")
start_time <- Sys.time()

model <- bam(
  cbind(n_unemployed, n_employed) ~
    education +
    # Time trends (education-specific)
    s(year_cont, by = education, bs = "ad", k = 100, id = 1) +
    # Seasonality
    s(month, bs = "cc", k = 12, id = 2) +
    ti(year_cont, month, bs = c("tp", "cc"), k = c(20, 12)) +
    s(month, by = education, bs = "cc", k = 12, id = 2),
  data = data,
  family = quasibinomial(),
  method = "fREML",
  discrete = TRUE,
  nthreads = 4
)

end_time <- Sys.time()
elapsed <- as.numeric(difftime(end_time, start_time, units = "secs"))

cat("Runtime:", round(elapsed, 1), "seconds\n")
cat("Converged:", model$converged, "\n")
```

### Model Performance

```{r}
#| label: model-performance
cat("Model Performance:\n")
cat("- Deviance explained:", round(summary(model)$dev.expl * 100, 1), "%\n")
cat("- Dispersion:", round(summary(model)$dispersion, 2), "\n\n")

cat("Smooth term EDFs:\n")
st <- summary(model)$s.table
print(round(st[, c("edf", "Ref.df", "F")], 1))
```

---

## 1. Full Model Predictions with Data

These plots show the complete model predictions (including both time trend and seasonal effects) overlaid on the observed data.

```{r}
#| label: full-predictions-setup
# Get predictions for observed data
data[, observed_rate := n_unemployed / (n_unemployed + n_employed)]

preds <- predict(model, type = "response", se.fit = TRUE)
data[, fitted := preds$fit]
data[, se := preds$se.fit]
data[, ci_lower := pmax(0, fitted - 1.96 * se)]
data[, ci_upper := pmin(1, fitted + 1.96 * se)]
```

### By Education Level (Faceted)

```{r}
#| label: full-predictions-faceted
#| fig-height: 14
#| fig-width: 12

ggplot(data, aes(x = year_cont)) +
  geom_point(aes(y = observed_rate * 100), alpha = 0.3, size = 0.5, color = "gray40") +
  geom_ribbon(aes(ymin = ci_lower * 100, ymax = ci_upper * 100), alpha = 0.3, fill = "steelblue") +
  geom_line(aes(y = fitted * 100), color = "steelblue", linewidth = 0.8) +
  facet_wrap(~education, scales = "free_y", ncol = 2, labeller = labeller(education = edu_labels)) +
  labs(
    title = "Full Model Predictions by Education Level",
    subtitle = "Model fit with 95% CI overlaid on observed unemployment rates",
    x = "Year",
    y = "Unemployment Rate (%)"
  ) +
  theme_minimal(base_size = 11) +
  theme(
    strip.text = element_text(face = "bold"),
    panel.grid.minor = element_blank()
  )
```

### All Education Levels Combined

```{r}
#| label: full-predictions-combined
#| fig-height: 7
#| fig-width: 12

ggplot(data, aes(x = year_cont, color = education, fill = education)) +
  geom_point(aes(y = observed_rate * 100), alpha = 0.15, size = 0.3) +
  geom_ribbon(aes(ymin = ci_lower * 100, ymax = ci_upper * 100), alpha = 0.1, color = NA) +
  geom_line(aes(y = fitted * 100), linewidth = 0.8) +
  scale_color_manual(values = edu_colors, labels = edu_labels) +
  scale_fill_manual(values = edu_colors, labels = edu_labels) +
  labs(
    title = "Full Model Predictions Across All Education Levels",
    subtitle = "Higher education consistently associated with lower unemployment",
    x = "Year",
    y = "Unemployment Rate (%)",
    color = "Education",
    fill = "Education"
  ) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "right")
```

---

## 2. Time Trend Marginal Effects (Averaged Over Seasonality)

These plots show model predictions **averaged across all 12 months**, giving true marginal effects that integrate out seasonal variation.

```{r}
#| label: time-marginal-setup
# Create prediction grid: vary year_cont, average over all months
edu_levels <- levels(data$education)
year_seq <- seq(min(data$year_cont), max(data$year_cont), length.out = 200)

time_marginal <- data.table()

for (edu in edu_levels) {
  # Predict at each year for all 12 months, then average
  year_preds <- sapply(year_seq, function(yr) {
    pred_grid <- data.frame(
      education = factor(edu, levels = edu_levels),
      year_cont = yr,
      month = 1:12
    )
    preds <- predict(model, newdata = pred_grid, type = "response", se.fit = TRUE)
    c(mean(preds$fit), mean(preds$se.fit))  # Average across months
  })

  time_marginal <- rbind(time_marginal, data.table(
    education = edu,
    year_cont = year_seq,
    fitted = year_preds[1, ],
    se = year_preds[2, ],
    ci_lower = pmax(0, year_preds[1, ] - 1.96 * year_preds[2, ]),
    ci_upper = pmin(1, year_preds[1, ] + 1.96 * year_preds[2, ])
  ))
}
```

### By Education Level (Faceted)

```{r}
#| label: time-marginal-faceted
#| fig-height: 14
#| fig-width: 12

ggplot(time_marginal, aes(x = year_cont)) +
  geom_ribbon(aes(ymin = ci_lower * 100, ymax = ci_upper * 100), alpha = 0.3, fill = "steelblue") +
  geom_line(aes(y = fitted * 100), color = "steelblue", linewidth = 1) +
  geom_vline(xintercept = c(2008, 2020), linetype = "dotted", alpha = 0.5, color = "red") +
  facet_wrap(~education, scales = "free_y", ncol = 2, labeller = labeller(education = edu_labels)) +
  labs(
    title = "Time Trend Marginal Effects by Education Level",
    subtitle = "Averaged across all 12 months; red lines mark 2008 and 2020",
    x = "Year",
    y = "Predicted Unemployment Rate (%)"
  ) +
  theme_minimal(base_size = 11) +
  theme(
    strip.text = element_text(face = "bold"),
    panel.grid.minor = element_blank()
  )
```

### All Education Levels Combined

```{r}
#| label: time-marginal-combined
#| fig-height: 7
#| fig-width: 12

ggplot(time_marginal, aes(x = year_cont, color = education, fill = education)) +
  geom_ribbon(aes(ymin = ci_lower * 100, ymax = ci_upper * 100), alpha = 0.1, color = NA) +
  geom_line(aes(y = fitted * 100), linewidth = 0.8) +
  geom_vline(xintercept = c(2008, 2020), linetype = "dotted", alpha = 0.5, color = "red") +
  scale_color_manual(values = edu_colors, labels = edu_labels) +
  scale_fill_manual(values = edu_colors, labels = edu_labels) +
  labs(
    title = "Time Trend Marginal Effects Across Education Levels",
    subtitle = "Averaged across all 12 months; red lines mark 2008 and 2020",
    x = "Year",
    y = "Predicted Unemployment Rate (%)",
    color = "Education",
    fill = "Education"
  ) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "right")
```

---

## 3. Seasonal Marginal Effects (Year = 2025)

These plots show model predictions with **year held constant at 2025**, varying month to isolate the seasonal pattern.

```{r}
#| label: seasonal-marginal-setup
# Create prediction grid: hold year at 2025, vary month
month_seq <- seq(1, 12, length.out = 100)  # Smooth over months

seasonal_marginal <- data.table()

for (edu in edu_levels) {
  pred_grid <- data.frame(
    education = factor(edu, levels = edu_levels),
    year_cont = 2025,  # Hold year constant
    month = month_seq
  )

  preds <- predict(model, newdata = pred_grid, type = "response", se.fit = TRUE)

  seasonal_marginal <- rbind(seasonal_marginal, data.table(
    education = edu,
    month = month_seq,
    fitted = as.numeric(preds$fit),
    se = as.numeric(preds$se.fit),
    ci_lower = pmax(0, as.numeric(preds$fit) - 1.96 * as.numeric(preds$se.fit)),
    ci_upper = pmin(1, as.numeric(preds$fit) + 1.96 * as.numeric(preds$se.fit))
  ))
}
```

### By Education Level (Faceted)

```{r}
#| label: seasonal-marginal-faceted
#| fig-height: 14
#| fig-width: 12

ggplot(seasonal_marginal, aes(x = month)) +
  geom_ribbon(aes(ymin = ci_lower * 100, ymax = ci_upper * 100), alpha = 0.3, fill = "steelblue") +
  geom_line(aes(y = fitted * 100), color = "steelblue", linewidth = 1) +
  scale_x_continuous(breaks = 1:12, labels = month.abb) +
  facet_wrap(~education, scales = "free_y", ncol = 2, labeller = labeller(education = edu_labels)) +
  labs(
    title = "Seasonal Marginal Effects by Education Level (Year = 2025)",
    subtitle = "Year held constant at 2025 to isolate seasonal pattern",
    x = "Month",
    y = "Predicted Unemployment Rate (%)"
  ) +
  theme_minimal(base_size = 11) +
  theme(
    strip.text = element_text(face = "bold"),
    panel.grid.minor = element_blank()
  )
```

### All Education Levels Combined (Mean-Centered)

```{r}
#| label: seasonal-marginal-combined
#| fig-height: 7
#| fig-width: 12

# Center each education level by subtracting its mean for comparability
seasonal_marginal_centered <- copy(seasonal_marginal)
seasonal_marginal_centered[, fitted_pct := fitted * 100]
seasonal_marginal_centered[, mean_pct := mean(fitted_pct), by = education]
seasonal_marginal_centered[, centered := fitted_pct - mean_pct]
seasonal_marginal_centered[, ci_lower_c := (ci_lower * 100) - mean_pct]
seasonal_marginal_centered[, ci_upper_c := (ci_upper * 100) - mean_pct]

ggplot(seasonal_marginal_centered, aes(x = month, color = education, fill = education)) +
  geom_ribbon(aes(ymin = ci_lower_c, ymax = ci_upper_c), alpha = 0.1, color = NA) +
  geom_line(aes(y = centered), linewidth = 0.8) +
  geom_hline(yintercept = 0, linetype = "dashed", alpha = 0.5) +
  scale_x_continuous(breaks = 1:12, labels = month.abb) +
  scale_color_manual(values = edu_colors, labels = edu_labels) +
  scale_fill_manual(values = edu_colors, labels = edu_labels) +
  labs(
    title = "Seasonal Marginal Effects Across Education Levels (Mean-Centered)",
    subtitle = "Each level centered at its own mean; year held at 2025",
    x = "Month",
    y = "Deviation from Mean Unemployment Rate (pp)",
    color = "Education",
    fill = "Education"
  ) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "right")
```

---

## 4. Time-Varying Seasonality

This plot shows how the seasonal pattern has changed over time, visualizing the `ti(year_cont, month)` tensor product interaction.

```{r}
#| label: time-varying-seasonality
#| fig-height: 8
#| fig-width: 12

# Create grid for all years
years_to_plot <- min(data$year):max(data$year)
month_seq <- 1:12

tv_seasonal <- data.table()

for (yr in years_to_plot) {
  pred_grid <- data.frame(
    education = factor("bachelors", levels = edu_levels),  # Use one level as reference
    year_cont = yr,
    month = month_seq
  )

  preds <- predict(model, newdata = pred_grid, type = "link", se.fit = TRUE)

  # Get baseline (annual mean) for this year
  baseline_grid <- pred_grid
  baseline_grid$month <- 6  # June as reference

  baseline <- predict(model, newdata = baseline_grid, type = "link")

  tv_seasonal <- rbind(tv_seasonal, data.table(
    year = factor(yr),
    month = month_seq,
    effect = as.numeric(preds$fit) - as.numeric(baseline),
    se = as.numeric(preds$se.fit)
  ))
}

ggplot(tv_seasonal, aes(x = month, y = effect, color = year)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2) +
  geom_hline(yintercept = 0, linetype = "dashed", alpha = 0.5) +
  scale_x_continuous(breaks = 1:12, labels = month.abb) +
  scale_color_viridis_d(option = "plasma") +
  labs(
    title = "Time-Varying Seasonality: How Seasonal Patterns Changed Over Time",
    subtitle = "Deviation from June baseline (log-odds scale) - captures ti(year, month) interaction",
    x = "Month",
    y = "Seasonal Effect (log-odds deviation from June)",
    color = "Year"
  ) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "right")
```

---

## 5. Recent Trends (2020-2025 Zoom)

Zoomed view of unemployment trends since the pandemic across all education levels.

```{r}
#| label: recent-trends-zoom
#| fig-height: 8
#| fig-width: 8

# Create prediction grid for 2020-2025, marginalized over months
recent_years <- seq(2020, 2025.9, length.out = 100)

recent_trends <- data.table()

for (edu in edu_levels) {
  # Predict at each year for all 12 months, then average
  year_preds <- sapply(recent_years, function(yr) {
    pred_grid <- data.frame(
      education = factor(edu, levels = edu_levels),
      year_cont = yr,
      month = 1:12
    )
    preds <- predict(model, newdata = pred_grid, type = "response", se.fit = TRUE)
    c(mean(preds$fit), mean(preds$se.fit))
  })

  recent_trends <- rbind(recent_trends, data.table(
    education = edu,
    year_cont = recent_years,
    fitted = year_preds[1, ],
    se = year_preds[2, ],
    ci_lower = pmax(0, year_preds[1, ] - 1.96 * year_preds[2, ]),
    ci_upper = pmin(1, year_preds[1, ] + 1.96 * year_preds[2, ])
  ))
}

ggplot(recent_trends, aes(x = year_cont, color = education, fill = education)) +
  geom_ribbon(aes(ymin = ci_lower * 100, ymax = ci_upper * 100), alpha = 0.15, color = NA) +
  geom_line(aes(y = fitted * 100), linewidth = 1) +
  scale_color_manual(values = edu_colors, labels = edu_labels) +
  scale_fill_manual(values = edu_colors, labels = edu_labels) +
  scale_x_continuous(breaks = 2020:2026) +
  labs(
    title = "Recent Unemployment Trends (2020-2025)",
    subtitle = "Marginal effects averaged across all 12 months; shaded areas show 95% CI",
    x = "Year",
    y = "Predicted Unemployment Rate (%)",
    color = "Education",
    fill = "Education"
  ) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 45, hjust = 1))
```

---

## 6. Model Diagnostics

```{r}
#| label: diagnostics
#| fig-height: 8
#| fig-width: 12

par(mfrow = c(2, 2))

# 1. Residuals vs fitted
plot(fitted(model), residuals(model, type = "deviance"),
     xlab = "Fitted values", ylab = "Deviance residuals",
     main = "Residuals vs Fitted", pch = 20, col = rgb(0, 0, 0, 0.2))
abline(h = 0, lty = 2, col = "red")

# 2. Q-Q plot
qqnorm(residuals(model, type = "deviance"), main = "Q-Q Plot of Residuals", pch = 20)
qqline(residuals(model, type = "deviance"), col = "red")

# 3. Histogram
hist(residuals(model, type = "deviance"), breaks = 50,
     main = "Histogram of Deviance Residuals", xlab = "Deviance residuals", col = "lightblue")

# 4. Residuals over time
plot(data$year_cont, residuals(model, type = "deviance"),
     xlab = "Year", ylab = "Deviance residuals",
     main = "Residuals over Time", pch = 20, col = rgb(0, 0, 0, 0.2))
abline(h = 0, lty = 2, col = "red")
```

### Seasonal Residual Check

```{r}
#| label: seasonal-residuals
#| fig-height: 5
#| fig-width: 10

data[, resid := observed_rate - fitted]
seasonal_resid <- data[, .(mean_resid = mean(resid)), by = .(education, month)]

ggplot(seasonal_resid, aes(x = month, y = mean_resid * 100, color = education)) +
  geom_line(linewidth = 0.8) +
  geom_point(size = 2) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  scale_x_continuous(breaks = 1:12, labels = month.abb) +
  scale_color_manual(values = edu_colors, labels = edu_labels) +
  labs(
    title = "Seasonal Residuals by Education",
    subtitle = "Should be near zero if seasonality is well-captured",
    x = "Month",
    y = "Mean Residual (percentage points)",
    color = "Education"
  ) +
  theme_minimal(base_size = 12)
```

---

## 7. Summary

```{r}
#| label: summary
cat("=== Model Summary ===\n\n")
cat("Model: cbind(n_unemployed, n_employed) ~\n")
cat("         education +\n")
cat("         s(year_cont, by = education, bs = 'ad', k = 100, id = 1) + # Education time trends\n")
cat("         s(month, bs = 'cc', k = 12, id = 2) +                # Global seasonality\n")
cat("         ti(year_cont, month, bs = c('tp', 'cc'), k = c(20, 12)) + # Time-varying seasonality\n")
cat("         s(month, by = education, bs = 'cc', k = 12, id = 2)      # Education seasonal deviations\n\n")
cat("Family: Quasi-binomial\n")
cat("Deviance explained:", round(summary(model)$dev.expl * 100, 1), "%\n")
cat("Dispersion:", round(summary(model)$dispersion, 2), "\n")
cat("Observations:", nrow(data), "\n")
cat("Education levels:", length(edu_levels), "\n")
```
