---
title: "PhD Unemployment in Context: A Quasi-Binomial Analysis Across Education Levels"
author: "PhD Unemployment Research"
date: today
format:
  html:
    toc: true
    toc-depth: 3
    code-fold: true
    code-summary: "Show code"
    theme: cosmo
    highlight-style: github
    embed-resources: true
    self-contained: true
execute:
  echo: false
  warning: false
  message: false
  cache: false
---

## Executive Summary

This analysis models unemployment rates across seven education levels using a quasi-binomial generalized additive model (GAM) fit to 25 years (2000-2025) of monthly Current Population Survey data. By analyzing all education levels in a single model, we can:

1. **Quantify PhD unemployment premium** relative to other degrees
2. **Measure how economic cycles affect different education groups** differently
3. **Identify seasonal patterns** in labor market dynamics
4. **Account for overdispersion** in unemployment count data (dispersion = 14.76)

### Key Finding

PhD unemployment averages **1.7%** over 25 years but has risen to **2.6%** recently. Using quasi-binomial models reveals substantial overdispersion (14.76×), demonstrating that standard binomial assumptions severely underestimate uncertainty.

---

## Data & Methods

```{r}
library(phdunemployment)
library(here)
library(mgcv)
library(data.table)
library(ggplot2)
library(tidyr)
library(dplyr)

# Load count data
counts_data <- readRDS(here("data", "education-spectrum-counts.rds"))

# Display data summary
cat("Data Summary:\n")
cat("- Time period:", min(counts_data$year), "to", max(counts_data$year), "\n")
cat("- Total months:", nrow(counts_data) / length(unique(counts_data$education)), "\n")
cat("- Education levels:", length(unique(counts_data$education)), "\n")
cat("- Total observations:", nrow(counts_data), "\n\n")

# Education level summary
summary_by_ed <- counts_data %>%
  group_by(education) %>%
  summarise(
    n_months = n(),
    mean_unemp_rate = mean(unemployment_rate, na.rm = TRUE),
    max_unemp_rate = max(unemployment_rate, na.rm = TRUE),
    min_unemp_rate = min(unemployment_rate, na.rm = TRUE),
    sd_unemp_rate = sd(unemployment_rate, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(desc(mean_unemp_rate))

print(summary_by_ed)
```

### Model Specification

We fit a quasi-binomial GAM with the formula:

$$\text{cbind}(n_{unemployed}, n_{employed}) \sim \text{education} + s(\text{time\_index}) + s(\text{month}, \text{bs}=\text{"cc"})$$

**Model components:**
- **education**: Main effect for each education level (intercept differences)
- **s(time_index)**: Smooth trend over 25 years captures long-term unemployment dynamics
- **s(month, bs="cc")**: Cyclic cubic spline for seasonal patterns shared across education levels
- **Family**: Quasi-binomial with automatic dispersion estimation
- **Method**: REML (marginal likelihood maximization)

---

## Model Fitting & Diagnostics

```{r}
# Fit both quasi-binomial and standard binomial models
model_result_quasi <- fit_education_binomial_gam(counts_data, use_quasi = TRUE)
model_result_binomial <- fit_education_binomial_gam(counts_data, use_quasi = FALSE)
model <- model_result_quasi$model

# Display summary
cat("=== QUASI-BINOMIAL MODEL SUMMARY ===\n\n")
cat("Convergence:", model_result_quasi$convergence_info$converged, "\n")
cat("Deviance explained:", round(model_result_quasi$summary_stats$deviance_explained * 100, 1), "%\n")
cat("Dispersion parameter:", round(model_result_quasi$summary_stats$dispersion, 2), "\n")
cat("\nDispersion interpretation:\n")
cat("- Value > 1 indicates OVERDISPERSION (expected for count data)\n")
cat("- This value (", round(model_result_quasi$summary_stats$dispersion, 2),
    ") means quasi-binomial is\n")
cat("  critical: binomial SEs would be",
    round(sqrt(model_result_quasi$summary_stats$dispersion), 1),
    "× too small!\n")

# Summary statistics
cat("\n=== SMOOTHING COMPONENTS ===\n")
summary(model)
```

### Binomial vs Quasi-Binomial Comparison

```{r}
# Compare standard errors between binomial and quasi-binomial at a fixed time point
pred_data_comparison <- data.frame(
  education = rep(unique(counts_data$education), 2),
  time_index = 200,
  month = 6,
  model_type = rep(c("quasi-binomial", "binomial"), each = length(unique(counts_data$education)))
)

# Get predictions from both models
preds_quasi <- predict(model_result_quasi$model,
                       newdata = pred_data_comparison[pred_data_comparison$model_type == "quasi-binomial", ],
                       type = "response", se.fit = TRUE)
preds_binomial <- predict(model_result_binomial$model,
                          newdata = pred_data_comparison[pred_data_comparison$model_type == "binomial", ],
                          type = "response", se.fit = TRUE)

comparison_df <- data.frame(
  education = unique(counts_data$education),
  quasi_se = preds_quasi$se.fit,
  binomial_se = preds_binomial$se.fit,
  ratio = preds_quasi$se.fit / preds_binomial$se.fit
)

cat("=== STANDARD ERROR COMPARISON (Time Index 200, Month 6) ===\n\n")
cat("Quasi-Binomial vs Binomial Standard Errors:\n")
cat("(Ratio shows how much larger quasi-binomial SEs are)\n\n")
print(comparison_df)

cat("\n\nAverage SE ratio:", round(mean(comparison_df$ratio), 2), "\n")
cat("This matches the dispersion parameter √",
    round(model_result_quasi$summary_stats$dispersion, 2), " = ",
    round(sqrt(model_result_quasi$summary_stats$dispersion), 2), "\n")
```

### Model Diagnostics Plots

```{r fig.height=10, fig.width=12}
# Standard GAM diagnostics
par(mfrow = c(2, 2))
plot(model, pages = 1, shade = TRUE)
par(mfrow = c(1, 1))
```

These plots show:
- **Top-left**: Trend smooth over time (education adjusted)
- **Top-right**: Seasonal pattern (education adjusted)
- **Bottom**: Residual diagnostics

---

## Education-Specific Unemployment Estimates

### Current Unemployment Rates (December 2025)

```{r}
# Get latest estimates
current_estimates <- predict_education_unemployment(
  model_result_quasi,
  time_point = 308,  # Dec 2025 (latest)
  month = 12
)

# Format for display
current_est_display <- current_estimates %>%
  mutate(
    unemployment_rate = paste0(round(unemployment_rate * 100, 2), "%"),
    ci_lower = paste0(round(ci_lower * 100, 2), "%"),
    ci_upper = paste0(round(ci_upper * 100, 2), "%")
  ) %>%
  rename(
    Education = education,
    `Unemployment Rate` = unemployment_rate,
    `95% CI Lower` = ci_lower,
    `95% CI Upper` = ci_upper
  ) %>%
  arrange(desc(`Unemployment Rate`))

knitr::kable(current_est_display, caption = "Current Unemployment Estimates (Dec 2025)")
```

### Unemployment Trend by Education Level

```{r fig.height=10, fig.width=14}
# Create seasonality-free trend predictions (fixed month = 6)
unique_times <- unique(model_result_quasi$data[, c("year", "time_index")])
unique_times <- unique_times[order(unique_times$time_index), ]

trend_pred_data <- expand.grid(
  time_index = unique_times$time_index,
  month = 6,  # Fixed month to remove seasonality
  education = unique(model_result_quasi$data$education)
)

trend_preds <- predict(model, newdata = trend_pred_data, type = "response", se.fit = TRUE)

predictions_by_time <- data.frame(
  education = trend_pred_data$education,
  time_index = trend_pred_data$time_index,
  date = as.Date(paste0(
    2000 + floor((trend_pred_data$time_index - 1) / 12), "-",
    formatC(((trend_pred_data$time_index - 1) %% 12) + 1, width = 2, flag = "0"), "-01"
  )),
  unemployment_rate = trend_preds$fit,
  se = trend_preds$se.fit,
  ci_lower = pmax(0, trend_preds$fit - 1.96 * trend_preds$se.fit),
  ci_upper = pmin(1, trend_preds$fit + 1.96 * trend_preds$se.fit)
)

# Extract raw data for points (all observations)
raw_data <- counts_data %>%
  mutate(date = as.Date(paste0(year, "-", month, "-01"))) %>%
  select(education, date, unemployment_rate)

# Plot with raw data, seasonality-free trend, and CIs
ggplot(predictions_by_time, aes(x = date, y = unemployment_rate * 100, color = education, fill = education)) +
  geom_ribbon(aes(ymin = ci_lower * 100, ymax = ci_upper * 100), alpha = 0.2, color = NA) +
  geom_point(data = raw_data, aes(y = unemployment_rate * 100), alpha = 0.2, size = 1) +
  geom_line(linewidth = 1.2) +
  scale_color_manual(
    values = c("phd" = "#2E86AB", "masters" = "#A23B72", "bachelors" = "#F18F01",
               "high_school" = "#C73E1D", "some_college" = "#6A994E",
               "less_than_hs" = "#BC4749", "associates" = "#8E7DBE")
  ) +
  scale_fill_manual(
    values = c("phd" = "#2E86AB", "masters" = "#A23B72", "bachelors" = "#F18F01",
               "high_school" = "#C73E1D", "some_college" = "#6A994E",
               "less_than_hs" = "#BC4749", "associates" = "#8E7DBE")
  ) +
  labs(
    title = "Unemployment Trends by Education Level (2000-2025)",
    subtitle = "Seasonality-free trends (June), raw data (faint points), and 95% CIs (shaded regions)",
    x = "Year",
    y = "Unemployment Rate (%)",
    color = "Education Level",
    fill = "Education Level"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    legend.position = "bottom",
    panel.grid.minor = element_blank()
  )
```

---

## Comparative Analysis: PhD vs Other Degrees

### PhD vs All Other Education Levels

```{r fig.height=10, fig.width=12}
# Compare PhD to others
comparison_data <- predictions_by_time %>%
  mutate(
    group = if_else(education == "phd", "PhD", "Other Education Levels")
  ) %>%
  group_by(date, group) %>%
  summarise(unemployment_rate = mean(unemployment_rate, na.rm = TRUE), .groups = "drop")

ggplot(comparison_data, aes(x = date, y = unemployment_rate * 100, color = group, linewidth = group)) +
  geom_line() +
  scale_linewidth_manual(values = c("PhD" = 1.5, "Other Education Levels" = 0.7)) +
  scale_color_manual(values = c("PhD" = "#2E86AB", "Other Education Levels" = "#A23B72")) +
  labs(
    title = "PhD vs Average Unemployment Rate",
    subtitle = "PhD consistently lower than other education levels",
    x = "Year",
    y = "Unemployment Rate (%)",
    color = NULL,
    linewidth = NULL
  ) +
  theme_minimal(base_size = 12) +
  theme(
    legend.position = "bottom",
    panel.grid.minor = element_blank()
  )
```

### Economic Downturn Response

```{r fig.height=8, fig.width=12}
# Highlight recessions
recession_periods <- data.frame(
  start = as.Date(c("2007-12-01", "2020-03-01")),
  end = as.Date(c("2009-06-01", "2020-05-01")),
  recession = c("2008 Financial Crisis", "COVID-19 Pandemic")
)

# Create comparison of PhD vs selected education levels
compare_levels <- c("phd", "masters", "bachelors", "high_school")
compare_data <- predictions_by_time %>%
  filter(education %in% compare_levels) %>%
  mutate(education = factor(education, levels = compare_levels))

ggplot(compare_data, aes(x = date, y = unemployment_rate * 100, color = education, linewidth = education)) +
  geom_rect(
    data = recession_periods,
    aes(xmin = start, xmax = end, ymin = -Inf, ymax = Inf, fill = recession),
    alpha = 0.15,
    color = NA,
    inherit.aes = FALSE
  ) +
  geom_line() +
  scale_linewidth_manual(values = c("phd" = 1.5, "masters" = 1.2, "bachelors" = 1, "high_school" = 0.8)) +
  scale_color_manual(
    values = c("phd" = "#2E86AB", "masters" = "#A23B72", "bachelors" = "#F18F01", "high_school" = "#C73E1D")
  ) +
  scale_fill_manual(values = c("2008 Financial Crisis" = "#FF6B6B", "COVID-19 Pandemic" = "#4ECDC4")) +
  labs(
    title = "Unemployment by Education Level: Economic Downturn Sensitivity",
    subtitle = "Gray regions mark recessions. PhD unemployment is less cyclical.",
    x = "Year",
    y = "Unemployment Rate (%)",
    color = "Education Level",
    linewidth = "Education Level",
    fill = NULL
  ) +
  theme_minimal(base_size = 12) +
  theme(
    legend.position = "bottom",
    panel.grid.minor = element_blank()
  )
```

---

## Seasonal Patterns

### Monthly Seasonal Effects

```{r fig.height=9, fig.width=14}
# Extract seasonal component by fitting predictions at varying months
seasonal_data <- expand_grid(
  education = unique(counts_data$education),
  time_index = 200,  # Mid-series
  month = 1:12
) %>%
  as.data.frame()

seasonal_preds <- predict(model, newdata = seasonal_data, type = "response", se.fit = TRUE)

seasonal_plot_data <- data.frame(
  education = seasonal_data$education,
  month = seasonal_data$month,
  unemployment_rate = seasonal_preds$fit,
  se = seasonal_preds$se.fit,
  ci_lower = pmax(0, seasonal_preds$fit - 1.96 * seasonal_preds$se.fit),
  ci_upper = pmin(1, seasonal_preds$fit + 1.96 * seasonal_preds$se.fit)
)

# Extract raw seasonal data (average by month across all years)
raw_seasonal <- counts_data %>%
  group_by(education, month) %>%
  summarise(unemployment_rate = mean(unemployment_rate, na.rm = TRUE), .groups = "drop")

ggplot(seasonal_plot_data, aes(x = month, y = unemployment_rate * 100, color = education, fill = education)) +
  geom_ribbon(aes(ymin = ci_lower * 100, ymax = ci_upper * 100), alpha = 0.2, color = NA) +
  geom_point(data = raw_seasonal, aes(y = unemployment_rate * 100), alpha = 0.4, size = 2) +
  geom_line(linewidth = 1) +
  scale_x_continuous(breaks = 1:12, labels = month.abb) +
  scale_color_manual(
    values = c("phd" = "#2E86AB", "masters" = "#A23B72", "bachelors" = "#F18F01",
               "high_school" = "#C73E1D", "some_college" = "#6A994E",
               "less_than_hs" = "#BC4749", "associates" = "#8E7DBE")
  ) +
  scale_fill_manual(
    values = c("phd" = "#2E86AB", "masters" = "#A23B72", "bachelors" = "#F18F01",
               "high_school" = "#C73E1D", "some_college" = "#6A994E",
               "less_than_hs" = "#BC4749", "associates" = "#8E7DBE")
  ) +
  labs(
    title = "Seasonal Unemployment Patterns by Education Level",
    subtitle = "Raw monthly averages (points), fitted seasonal component (lines), and 95% CIs (shaded regions)",
    x = "Month",
    y = "Unemployment Rate (%)",
    color = "Education Level",
    fill = "Education Level"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "bottom",
    panel.grid.minor = element_blank()
  )
```

**Observation**: The seasonal pattern is shared across all education levels - unemployment typically rises in winter months and falls in summer, reflecting academic and hiring cycles.

---

## Statistical Findings

### Education Level Differences

```{r}
# Get point estimates for each education level at a mid-range time point
mid_point_estimates <- predict_education_unemployment(
  model_result_quasi,
  time_point = 150,  # Mid 2012
  month = 6
) %>%
  arrange(unemployment_rate)

cat("=== UNEMPLOYMENT RATE HIERARCHY (June 2012) ===\n\n")
for (i in seq_len(nrow(mid_point_estimates))) {
  row <- mid_point_estimates[i, ]
  cat(sprintf(
    "%2d. %15s: %5.2f%% (95%% CI: %5.2f%% - %5.2f%%)\n",
    i,
    row$education,
    row$unemployment_rate * 100,
    row$ci_lower * 100,
    row$ci_upper * 100
  ))
}

# Calculate PhD premium/discount
phd_rate <- mid_point_estimates$unemployment_rate[mid_point_estimates$education == "phd"]
high_school_rate <- mid_point_estimates$unemployment_rate[mid_point_estimates$education == "high_school"]
less_than_hs_rate <- mid_point_estimates$unemployment_rate[mid_point_estimates$education == "less_than_hs"]

cat("\n=== PhD ADVANTAGE ===\n\n")
cat(sprintf("PhD vs High School:     %.2f%% lower (%.1f%% relative)\n",
  (high_school_rate - phd_rate) * 100,
  (high_school_rate - phd_rate) / phd_rate * 100
))
cat(sprintf("PhD vs Less than HS:    %.2f%% lower (%.1f%% relative)\n",
  (less_than_hs_rate - phd_rate) * 100,
  (less_than_hs_rate - phd_rate) / phd_rate * 100
))
```

### Dispersion and Model Fit

```{r}
cat("=== QUASI-BINOMIAL DIAGNOSTICS ===\n\n")
cat("Dispersion parameter: ", round(model_result_quasi$summary_stats$dispersion, 2), "\n")
cat("Deviance explained:   ", round(model_result_quasi$summary_stats$deviance_explained * 100, 1), "%\n\n")
cat("Interpretation:\n")
cat("- Dispersion >> 1 indicates OVERDISPERSION\n")
cat("- Our data shows ", round(model_result_quasi$summary_stats$dispersion, 2), "× dispersion\n")
cat("- Quasi-binomial is ESSENTIAL (binomial SEs would be ",
    round(sqrt(model_result_quasi$summary_stats$dispersion), 1), "× too small)\n")
cat("- Deviance explained indicates ", round(model_result_quasi$summary_stats$deviance_explained * 100, 1),
    "% of variation captured\n")
```

---

## Conclusions

1. **PhD unemployment is genuinely lower** than other education levels across the full 2000-2025 period, with a **1.7% average** versus 3-5% for less educated groups.

2. **Quasi-binomial models are critical**: Standard binomial models would suggest 3-4× higher confidence than warranted. The large dispersion parameter (14.76) reflects natural variation in unemployment counts.

3. **Education premiums are stable**: The unemployment advantage of higher education persists through economic cycles, though all groups experience elevated unemployment during recessions.

4. **Seasonal patterns are shared**: All education levels show similar seasonal variation (peaking in winter, dipping in summer), reflecting common labor market dynamics.

5. **Recent concerning trend**: PhD unemployment has risen from 1.7% average to 2.6% in 2025, potentially reflecting:
   - Tighter academic job markets
   - Post-PhD visa/immigration changes
   - Field-specific labor market shifts
   - Post-pandemic labor market restructuring

---

## Technical Notes

**Model Estimation**: REML with 500 max iterations
**Smoothing basis**: Thin-plate regression splines for trends, cyclic cubic spline for seasonality
**Family**: Quasi-binomial with automatic dispersion estimation
**Data**: Current Population Survey monthly aggregates, 2000-2025
**Statistical software**: R 4.x with mgcv package

```{r}
sessionInfo()
```
