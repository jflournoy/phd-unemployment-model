---
title: "CPS Data Generation Report"
subtitle: "Overview of Derived Datasets for PhD Unemployment Analysis"
author: "PhD Unemployment Model Project"
date: today
format:
  html:
    toc: true
    toc-depth: 3
    code-fold: true
    code-summary: "Show code"
    theme: cosmo
    embed-resources: true
execute:
  echo: true
  warning: false
  message: false
---

## Overview

This report documents the three core datasets generated from raw IPUMS CPS microdata for PhD unemployment analysis. These datasets support different modeling approaches:

1. **Education Spectrum Counts**: Unweighted person counts for binomial/quasi-binomial GAMs
2. **PhD Monthly Unemployment**: PhD-specific time series for seasonal analysis
3. **Multi-Education Unemployment**: Weighted data for cross-education comparisons

All datasets are generated by the reproducible pipeline in `data-raw/generate-derived-data.R`.

```{r setup}
library(ggplot2)
library(here)

# Load the three core datasets
edu_counts <- readRDS(here("data", "education-spectrum-counts.rds"))
phd_monthly <- readRDS(here("data", "phd-monthly-unemployment.rds"))
multi_edu <- readRDS(here("data", "multi-education-unemployment.rds"))

# Add date columns where missing
# Use unclass() to strip haven_labelled attributes
if (!"date" %in% names(edu_counts)) {
  edu_counts$date <- as.Date(paste(edu_counts$year, unclass(edu_counts$month), "01", sep = "-"))
}
if (!"date" %in% names(multi_edu)) {
  multi_edu$date <- as.Date(paste(multi_edu$year, unclass(multi_edu$month), "01", sep = "-"))
}

# Set ggplot theme
theme_set(theme_minimal(base_size = 12))
```

## Dataset 1: Education Spectrum Counts

**Purpose**: Unweighted person counts for binomial/quasi-binomial GAM modeling

**File**: `data/education-spectrum-counts.rds`

### Structure

```{r edu-counts-structure}
# Dimensions
cat("Dimensions:", nrow(edu_counts), "rows ×", ncol(edu_counts), "columns\n\n")

# Column names and types
cat("Columns:\n")
str(edu_counts)

# Time range
cat("\nTime range:", min(edu_counts$year), "-", max(edu_counts$year), "\n")

# Education levels
cat("Education levels:", length(unique(edu_counts$education)), "\n")
cat("  ", paste(sort(unique(edu_counts$education)), collapse = ", "), "\n")
```

### Sample Data

```{r edu-counts-sample}
head(edu_counts, 10)
```

### Summary Statistics

```{r edu-counts-summary}
cat("Total unemployed persons:", format(sum(edu_counts$n_unemployed), big.mark = ","), "\n")
cat("Total labor force:", format(sum(edu_counts$n_total), big.mark = ","), "\n")
cat("Overall unemployment rate:", sprintf("%.2f%%", 100 * mean(edu_counts$unemployment_rate)), "\n")
```

### Visualization: Unemployment Rates by Education Over Time

```{r edu-counts-plot, fig.width=10, fig.height=6}
ggplot(edu_counts, aes(x = date, y = unemployment_rate, color = education)) +
  geom_line(linewidth = 0.7) +
  scale_y_continuous(labels = scales::percent_format(), limits = c(0, NA)) +
  scale_x_date(date_breaks = "2 years", date_labels = "%Y") +
  labs(
    title = "Unemployment Rates by Education Level (2000-2025)",
    subtitle = "Unweighted person counts from CPS microdata",
    x = NULL,
    y = "Unemployment Rate",
    color = "Education"
  ) +
  theme(legend.position = "bottom") +
  guides(color = guide_legend(nrow = 2))
```

### Visualization: Average Unemployment by Education

```{r edu-avg-plot, fig.width=8, fig.height=5}
# Calculate average by education
edu_avg <- aggregate(unemployment_rate ~ education, data = edu_counts, FUN = mean)
edu_avg <- edu_avg[order(edu_avg$unemployment_rate), ]
edu_avg$education <- factor(edu_avg$education, levels = edu_avg$education)

ggplot(edu_avg, aes(x = education, y = unemployment_rate, fill = education)) +
  geom_col(show.legend = FALSE) +
  geom_text(aes(label = sprintf("%.2f%%", 100 * unemployment_rate)),
            vjust = -0.5, size = 3.5) +
  scale_y_continuous(labels = scales::percent_format(),
                     limits = c(0, max(edu_avg$unemployment_rate) * 1.1)) +
  labs(
    title = "Average Unemployment Rate by Education (2000-2025)",
    subtitle = "Clear education gradient: higher education = lower unemployment",
    x = "Education Level",
    y = "Average Unemployment Rate"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### Visualization: Counts vs Rates

```{r counts-vs-rates-plot, fig.width=10, fig.height=6}
# Show that this dataset contains COUNTS not RATES
# Pick PhD data for Jan 2020 as example
phd_jan_2020 <- edu_counts[edu_counts$education == "phd" &
                            edu_counts$year == 2020 &
                            unclass(edu_counts$month) == 1, ]

# Create example data frame
count_example <- data.frame(
  Measure = c("Unemployed (count)", "Labor Force (count)", "Unemployment Rate"),
  Value = c(phd_jan_2020$n_unemployed,
            phd_jan_2020$n_total,
            phd_jan_2020$unemployment_rate),
  Type = c("Count", "Count", "Rate")
)

# Create two separate plots
library(gridExtra)

# Plot 1: Counts (absolute numbers)
p1 <- ggplot(count_example[count_example$Type == "Count", ],
             aes(x = Measure, y = Value, fill = Measure)) +
  geom_col(show.legend = FALSE) +
  geom_text(aes(label = format(round(Value), big.mark = ",")),
            vjust = -0.5, size = 4, fontface = "bold") +
  scale_y_continuous(labels = scales::comma, limits = c(0, max(count_example$Value[1:2]) * 1.15)) +
  scale_fill_manual(values = c("Unemployed (count)" = "#E63946",
                                "Labor Force (count)" = "#2E86AB")) +
  labs(
    title = "Dataset 1: Unweighted Person COUNTS",
    subtitle = "PhD holders, January 2020 - actual sample observations",
    x = NULL,
    y = "Number of Persons"
  ) +
  theme(axis.text.x = element_text(size = 10))

# Plot 2: Rate (proportion)
p2 <- ggplot(count_example[count_example$Type == "Rate", ],
             aes(x = Measure, y = Value, fill = Measure)) +
  geom_col(show.legend = FALSE, fill = "#457B9D") +
  geom_text(aes(label = sprintf("%.2f%%", 100 * Value)),
            vjust = -0.5, size = 4, fontface = "bold") +
  scale_y_continuous(labels = scales::percent, limits = c(0, max(count_example$Value[3]) * 1.5)) +
  labs(
    title = "Derived Rate (for reference)",
    subtitle = "Calculated from counts: unemployed / labor force",
    x = NULL,
    y = "Unemployment Rate"
  ) +
  theme(axis.text.x = element_text(size = 10))

# Combine plots
gridExtra::grid.arrange(p1, p2, ncol = 2)
```

**Key Difference**: Dataset 1 stores **integer counts** (n_unemployed = `r phd_jan_2020$n_unemployed`, n_total = `r phd_jan_2020$n_total`) suitable for binomial models, while the rate (`r sprintf("%.2f%%", 100 * phd_jan_2020$unemployment_rate)`) is derived from these counts.

## Dataset 2: PhD Monthly Unemployment

**Purpose**: PhD-specific time series for seasonal GAM modeling

**File**: `data/phd-monthly-unemployment.rds`

### Structure

```{r phd-structure}
# Dimensions
cat("Dimensions:", nrow(phd_monthly), "rows ×", ncol(phd_monthly), "columns\n\n")

# Column names and types
cat("Columns:\n")
str(phd_monthly)

# Time range
cat("\nTime range:", format(min(phd_monthly$date), "%Y-%m"), "to",
    format(max(phd_monthly$date), "%Y-%m"), "\n")
cat("Total months:", nrow(phd_monthly), "\n")
```

### Sample Data

```{r phd-sample}
head(phd_monthly, 10)
```

### Summary Statistics

```{r phd-summary}
cat("Mean unemployment rate:", sprintf("%.2f%%", 100 * mean(phd_monthly$unemployment_rate)), "\n")
cat("Min unemployment rate:", sprintf("%.2f%%", 100 * min(phd_monthly$unemployment_rate)), "\n")
cat("Max unemployment rate:", sprintf("%.2f%%", 100 * max(phd_monthly$unemployment_rate)), "\n")
cat("SD unemployment rate:", sprintf("%.2f%%", 100 * sd(phd_monthly$unemployment_rate)), "\n")
cat("\nMean sample size (weighted):", format(round(mean(phd_monthly$n_total)), big.mark = ","), "\n")
```

### Visualization: PhD Unemployment Time Series

```{r phd-timeseries-plot, fig.width=10, fig.height=6}
ggplot(phd_monthly, aes(x = date, y = unemployment_rate)) +
  geom_line(color = "#2E86AB", linewidth = 0.8) +
  geom_point(color = "#2E86AB", size = 0.5, alpha = 0.6) +
  geom_hline(yintercept = mean(phd_monthly$unemployment_rate),
             linetype = "dashed", color = "red", linewidth = 0.7) +
  annotate("text", x = as.Date("2002-01-01"),
           y = mean(phd_monthly$unemployment_rate) + 0.003,
           label = sprintf("Mean: %.2f%%", 100 * mean(phd_monthly$unemployment_rate)),
           color = "red", size = 3.5) +
  scale_y_continuous(labels = scales::percent_format(), limits = c(0, NA)) +
  scale_x_date(date_breaks = "2 years", date_labels = "%Y") +
  labs(
    title = "PhD Unemployment Rate (2000-2025)",
    subtitle = "Monthly time series with weighted CPS data (ASECWT for March, WTFINL otherwise)",
    x = NULL,
    y = "Unemployment Rate"
  )
```

### Visualization: PhD Unemployment by Month (Seasonal Pattern)

```{r phd-seasonal-plot, fig.width=9, fig.height=5}
# Calculate average by month
monthly_avg <- aggregate(unemployment_rate ~ month, data = phd_monthly, FUN = mean)
monthly_avg$month_name <- month.abb[monthly_avg$month]
monthly_avg$month_name <- factor(monthly_avg$month_name, levels = month.abb)

ggplot(monthly_avg, aes(x = month_name, y = unemployment_rate)) +
  geom_col(fill = "#2E86AB", alpha = 0.8) +
  geom_text(aes(label = sprintf("%.2f%%", 100 * unemployment_rate)),
            vjust = -0.5, size = 3) +
  scale_y_continuous(labels = scales::percent_format(),
                     limits = c(0, max(monthly_avg$unemployment_rate) * 1.15)) +
  labs(
    title = "Average PhD Unemployment by Month",
    subtitle = "Shows seasonal patterns across 2000-2025",
    x = "Month",
    y = "Average Unemployment Rate"
  )
```

### Visualization: Recent Trends (2020-2025)

```{r phd-recent-plot, fig.width=10, fig.height=5}
# Filter to recent years
phd_recent <- phd_monthly[phd_monthly$year >= 2020, ]

ggplot(phd_recent, aes(x = date, y = unemployment_rate)) +
  geom_line(color = "#2E86AB", linewidth = 1) +
  geom_point(color = "#2E86AB", size = 2) +
  geom_vline(xintercept = as.Date("2020-03-01"),
             linetype = "dotted", color = "red", linewidth = 0.8) +
  annotate("text", x = as.Date("2020-03-01"), y = 0.04,
           label = "COVID-19\nPandemic", color = "red", size = 3, hjust = -0.1) +
  scale_y_continuous(labels = scales::percent_format(), limits = c(0, 0.045)) +
  scale_x_date(date_breaks = "6 months", date_labels = "%b\n%Y") +
  labs(
    title = "Recent PhD Unemployment Trends (2020-2025)",
    subtitle = "Shows COVID-19 impact and recovery",
    x = NULL,
    y = "Unemployment Rate"
  )
```

## Dataset 3: Multi-Education Unemployment

**Purpose**: Weighted data for cross-education comparisons

**File**: `data/multi-education-unemployment.rds`

### Structure

```{r multi-structure}
# Dimensions
cat("Dimensions:", nrow(multi_edu), "rows ×", ncol(multi_edu), "columns\n\n")

# Column names and types
cat("Columns:\n")
str(multi_edu)

# Time range
cat("\nTime range:", min(multi_edu$year), "-", max(multi_edu$year), "\n")

# Education levels
cat("Education levels:", length(unique(multi_edu$education)), "\n")
cat("  ", paste(sort(unique(multi_edu$education)), collapse = ", "), "\n")
```

### Sample Data

```{r multi-sample}
head(multi_edu, 10)
```

### Summary by Education

```{r multi-summary}
# Calculate summary statistics by education
edu_summary <- aggregate(
  cbind(unemployment_rate, n_total) ~ education,
  data = multi_edu,
  FUN = mean
)

# Format nicely
edu_summary_df <- data.frame(
  Education = edu_summary$education,
  Avg_Unemployment = sprintf("%.2f%%", 100 * edu_summary$unemployment_rate),
  Avg_Sample_Size = format(round(edu_summary$n_total), big.mark = ",")
)

print(edu_summary_df)
```

### Visualization: Weighted vs Unweighted Comparison

```{r weighted-comparison-plot, fig.width=10, fig.height=6}
# Calculate averages for both datasets
weighted_avg <- aggregate(unemployment_rate ~ education, data = multi_edu, FUN = mean)
weighted_avg$type <- "Weighted (survey weights)"

unweighted_avg <- aggregate(unemployment_rate ~ education, data = edu_counts, FUN = mean)
unweighted_avg$type <- "Unweighted (person counts)"

# Combine
comparison <- rbind(weighted_avg, unweighted_avg)

# Order by weighted average
edu_order <- weighted_avg$education[order(weighted_avg$unemployment_rate)]
comparison$education <- factor(comparison$education, levels = edu_order)

ggplot(comparison, aes(x = education, y = unemployment_rate, fill = type)) +
  geom_col(position = "dodge") +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_fill_manual(values = c("Weighted (survey weights)" = "#2E86AB",
                                "Unweighted (person counts)" = "#A23B72")) +
  labs(
    title = "Weighted vs Unweighted Unemployment Rates by Education",
    subtitle = "Survey weights adjust for sampling design and non-response",
    x = "Education Level",
    y = "Average Unemployment Rate",
    fill = "Data Type"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "bottom")
```

### Visualization: Education Comparison Over Time

```{r multi-timeseries-plot, fig.width=12, fig.height=7}
# Filter to a few key education levels for clarity
key_education <- c("less_than_hs", "high_school", "bachelors", "masters", "phd")
multi_subset <- multi_edu[multi_edu$education %in% key_education, ]

# Create readable labels
label_map <- c(
  less_than_hs = "Less than HS",
  high_school = "High School",
  bachelors = "Bachelor's",
  masters = "Master's",
  phd = "PhD"
)
multi_subset$edu_label <- factor(
  label_map[multi_subset$education],
  levels = label_map
)

ggplot(multi_subset, aes(x = date, y = unemployment_rate, color = edu_label)) +
  geom_line(linewidth = 0.8) +
  scale_y_continuous(labels = scales::percent_format(), limits = c(0, NA)) +
  scale_x_date(date_breaks = "2 years", date_labels = "%Y") +
  scale_color_brewer(palette = "Set1") +
  labs(
    title = "Unemployment Rates by Education Level (Weighted Data)",
    subtitle = "Shows persistent education gradient across economic cycles",
    x = NULL,
    y = "Unemployment Rate",
    color = "Education"
  ) +
  theme(legend.position = "bottom")
```

## Data Quality Checks

### Completeness

```{r quality-checks}
# Check for missing values
cat("Missing unemployment rates:\n")
cat("  Education Spectrum Counts:", sum(is.na(edu_counts$unemployment_rate)), "\n")
cat("  PhD Monthly:", sum(is.na(phd_monthly$unemployment_rate)), "\n")
cat("  Multi-Education:", sum(is.na(multi_edu$unemployment_rate)), "\n\n")

# Check time coverage
cat("Time coverage (months):\n")
cat("  Education Spectrum Counts:", nrow(edu_counts) / length(unique(edu_counts$education)), "\n")
cat("  PhD Monthly:", nrow(phd_monthly), "\n")
cat("  Multi-Education:", nrow(multi_edu) / length(unique(multi_edu$education)), "\n\n")

# Check sample sizes
cat("Mean sample sizes:\n")
cat("  PhD Monthly (weighted):", format(round(mean(phd_monthly$n_total)), big.mark = ","), "\n")
cat("  Education Spectrum (unweighted):", format(round(mean(edu_counts$n_total)), big.mark = ","), "\n")
cat("  Multi-Education (weighted):", format(round(mean(multi_edu$n_total)), big.mark = ","), "\n")
```

### Visualization: Sample Sizes Over Time

```{r sample-size-plot, fig.width=10, fig.height=5}
ggplot(phd_monthly, aes(x = date, y = n_total / 1e6)) +
  geom_line(color = "#2E86AB", linewidth = 0.8) +
  geom_point(color = "#2E86AB", size = 1, alpha = 0.5) +
  labs(
    title = "PhD Sample Size Over Time (Weighted)",
    subtitle = "Shows effective sample size after applying survey weights",
    x = NULL,
    y = "Sample Size (millions)"
  ) +
  scale_x_date(date_breaks = "2 years", date_labels = "%Y")
```

## File Sizes

```{r file-sizes}
files <- c(
  "data/education-spectrum-counts.rds",
  "data/phd-monthly-unemployment.rds",
  "data/multi-education-unemployment.rds"
)

file_info <- data.frame(
  File = basename(files),
  Size_KB = sapply(files, function(f) round(file.size(here(f)) / 1024, 1)),
  Rows = c(nrow(edu_counts), nrow(phd_monthly), nrow(multi_edu)),
  Columns = c(ncol(edu_counts), ncol(phd_monthly), ncol(multi_edu))
)

print(file_info)
```

## Key Insights

### Education Gradient

The data clearly shows a strong **education gradient** in unemployment rates:

- **PhD holders have the lowest unemployment** (~1.74% average)
- **Less than high school has the highest** (~8.0% average)
- The gradient is **monotonic and persistent** across time

### PhD Unemployment Characteristics

PhD unemployment shows several notable features:

1. **Very low overall** - mean of 1.74%, much lower than general population
2. **Relatively stable** - standard deviation of ~0.8 percentage points
3. **Some seasonality** - visible patterns by month
4. **COVID-19 spike** - clear increase in 2020, followed by recovery

### Data Quality

All three datasets are:

- ✓ **Complete** - no missing values in unemployment rates
- ✓ **Comprehensive** - full monthly coverage 2000-2025
- ✓ **Adequate sample sizes** - sufficient for robust estimation
- ✓ **Ready for modeling** - proper structure for GAMs and time series analysis

## Next Steps

These datasets support:

1. **Binomial/quasi-binomial GAMs** - using `education-spectrum-counts.rds`
2. **Seasonal decomposition** - using `phd-monthly-unemployment.rds`
3. **Cross-education comparisons** - using `multi-education-unemployment.rds`
4. **Future Bayesian models** - via targets pipeline with caching

---

## Session Info

```{r session-info}
sessionInfo()
```

**Report generated**: `r Sys.time()`

**Data generation script**: `data-raw/generate-derived-data.R`

**Reproducible pipeline**: Run `targets::tar_make()` to regenerate all datasets
