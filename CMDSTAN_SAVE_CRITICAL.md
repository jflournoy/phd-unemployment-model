# CRITICAL: Saving CmdStan Fits Properly

**Date**: 2026-02-11
**Status**: **MANDATORY** - All cmdstanr fits MUST be saved with this approach

## The Problem

**CmdStanMCMC objects store references to temporary CSV files**. If you save the fit object with `saveRDS()` or `qsave()` WITHOUT preserving the CSV files, the fit object becomes **UNUSABLE** later.

### Symptom

```r
fit <- qread("models/my-fit.qs")
fit$summary("my_param")
# Error: File does not exist: '/tmp/RtmpXXX/model-1234.csv'
```

The fit object loads fine, but any operation that needs to read the samples fails because the CSV files don't exist.

## The Solution

**ALWAYS use `save_cmdstan_fit()` instead of `qsave()` or `saveRDS()`**

```r
# ❌ WRONG - CSV files will be lost
result <- list(fit = fit, data = data, diagnostics = diag)
qsave(result, "models/my-fit.qs")

# ✅ CORRECT - CSV files preserved
result <- list(fit = fit, data = data, diagnostics = diag)
save_cmdstan_fit(result, "models/my-fit.qs")
```

## Usage

### Saving Fits

```r
# After fitting a model
fit_result <- fit_ode_state_space_monotonic_spline(
  data = my_data,
  ...
)

# Save with CSV preservation
save_cmdstan_fit(
  fit_result,
  output_file = "models/my-model.qs",
  format = "qs"  # or "rds"
)
```

This will:
1. Save CSV files to `models/my-model_csv/`
2. Store the CSV directory path in the result
3. Save the result with `qsave()` or `saveRDS()`
4. Verify everything worked

### Loading Fits

```r
# Load the fit
result <- load_cmdstan_fit("models/my-model.qs")

# CSV files are automatically located
# You can now use fit$summary(), fit$draws(), etc.
result$fit$summary("mu_param")  # Works!
```

## Implementation Details

### File Structure

```
models/
├── my-model.qs              # Fit object and metadata
└── my-model_csv/            # CSV files
    ├── chain-1.csv
    ├── chain-2.csv
    ├── chain-3.csv
    └── chain-4.csv
```

### What Gets Saved

The result object stores:
- `fit`: CmdStanMCMC object (with corrected file paths)
- `data`: Stan data used for fitting
- `diagnostics`: Convergence diagnostics
- `csv_dir`: Path to CSV directory
- `csv_saved`: TRUE flag
- `save_time`: Timestamp

### Storage Cost

CSV files are large but necessary:
- Typical model: 100-500 MB for CSV files
- Trade-off: Disk space vs usability
- **Worth it** to avoid wasting hours debugging

## Updating Existing Code

### Find and Fix

```bash
# Find all unsafe saves
grep -rn "qsave.*fit\|saveRDS.*fit" R/ scripts/

# Replace with save_cmdstan_fit()
```

### For Fit Functions

Update all model fitting functions to return properly saveable results:

```r
fit_my_model <- function(...) {
  # ... fitting code ...

  result <- list(
    fit = fit,
    data = stan_data,
    diagnostics = get_diagnostics(fit),
    timing = list(elapsed_mins = elapsed)
  )

  # Document that users should use save_cmdstan_fit()
  message("\nTo save this fit with CSV files preserved:")
  message("  save_cmdstan_fit(result, 'models/my-fit.qs')")

  return(result)
}
```

## Verification

After saving, verify it works:

```r
# Save
save_cmdstan_fit(result, "models/test.qs")

# Immediately try to load
loaded <- load_cmdstan_fit("models/test.qs")

# Test that it works
loaded$fit$summary("lp__")  # Should work!
```

## Git Configuration

**Add to `.gitignore`**:

```
# CmdStan CSV files (large and reproducible)
models/*_csv/
```

CSV files can be regenerated by re-fitting, so they don't need to be in version control (but keep them locally!).

## Alternative: Save Draws Directly

For long-term archival where you don't need the full fit object:

```r
# Extract what you need
draws <- fit$draws(format = "draws_df")
summary <- fit$summary()

# Save these instead
saveRDS(list(draws = draws, summary = summary), "archive.rds")
```

This is smaller but you lose:
- Ability to compute new summaries
- Diagnostic information
- Flexibility

## Enforcement

**Code review checklist**:
- [ ] All `qsave()` calls for fits use `save_cmdstan_fit()`
- [ ] All `saveRDS()` calls for fits use `save_cmdstan_fit()`
- [ ] Scripts that fit models document how to save properly
- [ ] No raw `fit$save_output_files()` without proper wrapper

## Summary

| Action | Use This | NOT This |
|--------|---------|----------|
| **Save fit** | `save_cmdstan_fit(result, "file.qs")` | `qsave(result, "file.qs")` |
| **Load fit** | `load_cmdstan_fit("file.qs")` | `qread("file.qs")` |
| **Git ignore** | `models/*_csv/` | (don't ignore!) |

---

**Remember**: If you can't use `fit$summary()` after loading, the CSV files are missing. Don't waste time debugging - re-fit the model and save it properly!

---

**Last updated**: 2026-02-11
**File**: `R/save-cmdstan-fit.R`
